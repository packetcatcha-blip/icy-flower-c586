#!/usr/bin/env node
/**
 * Apply local LLM preference to .continue/config.json
 * - Reads scripts/detected-llms.json (generated by detect-llms.ps1)
 * - Moves detected local models to the top of the models array
 * - Sets "preferLocal": true in the config
 */
import fs from 'fs';
import path from 'path';

const repoRoot = path.resolve(new URL(import.meta.url).pathname, '..', '..');
const detectedPath = path.join(repoRoot, 'scripts', 'detected-llms.json');
const continueConfigPath = path.join(repoRoot, '.continue', 'config.json');

function loadJSON(p) {
  return JSON.parse(fs.readFileSync(p, 'utf8'));
}

function saveJSON(p, obj) {
  fs.writeFileSync(p, JSON.stringify(obj, null, 2) + '\n', 'utf8');
}

async function main() {
  if (!fs.existsSync(detectedPath)) {
    console.error('No detected-llms.json found. Run scripts/detect-llms.ps1 first.');
    process.exit(2);
  }

  const detected = loadJSON(detectedPath);
  const config = loadJSON(continueConfigPath);

  const detectedModels = (detected.models || []).map(m => ({ provider: m.provider, model: m.model }));

  // Build new models list: detected first, then rest (no dups)
  const existing = config.models || [];

  const newModels = [];
  const added = new Set();

  for (const d of detectedModels) {
    const found = existing.find(e => e.model === d.model || e.title === d.model || e.title === d.title);
    if (found) {
      newModels.push(found);
      added.add(found.model || found.title);
    } else {
      // create minimal entry so local model is usable
      newModels.push({ title: d.model, provider: d.provider, model: d.model, apiBase: d.apiBase || undefined });
      added.add(d.model);
    }
  }

  for (const e of existing) {
    const key = e.model || e.title;
    if (!added.has(key)) newModels.push(e);
  }

  config.models = newModels;
  config.preferLocal = true;
  config.localPriority = ['ollama', 'lmstudio', 'foundry'];

  saveJSON(continueConfigPath, config);
  console.log('APPLY_LLM_PREFERENCE_OK');
}

main().catch(err => {
  console.error(err);
  process.exit(1);
});
